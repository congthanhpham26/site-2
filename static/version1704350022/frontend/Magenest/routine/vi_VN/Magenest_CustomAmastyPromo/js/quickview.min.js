define(['jquery', 'mage/url', 'Magento_Catalog/js/price-utils', 'Magenest_CustomAmastyPromo/js/jquery.magnific-popup.min'], function($, urlBuilder, priceUtils) {
    'use strict';
    $.widget('magenest.quickview', {
        quickViewItem: 'a.product-quick-view, a.kit-quick-view, .mobile-kit-quick-view',
        promoItem: '.selected-promo-item',
        attribute: '.promo-attribute-select',
        addToCartBtn: '#product-addtocart-button',
        options: {
            products: null,
            promoSku: {},
            priceFormat: {},
        },
        _init: function() {
            var self = this;
            if ($('#product_addtocart_form').length > 0) {
                var radio = $('.ampromo-free-gift .ampromo-item:not(.disabled):first').find('.selected-promo-item');
                if (radio.length > 0) {
                    radio.trigger('click');
                }
            }
        },
        _updatePrice: function(products, item) {
            var priceHtml = $(item).parent().find('span[data-price-type="basePrice"]').find('span[class="price"]');
            if (priceHtml.length) {
                var itemPrice = priceHtml.html().replace(/[^.,0-9]/gim, ''),
                    discount = 0,
                    productSku = $(item).closest('div.ampromo-item').attr('data-product-sku'),
                    product = null;
                itemPrice = itemPrice.replace(',', '.');
                if (productSku in products) {
                    product = products[productSku];
                    var promoDiscount = String(product['discount']['discount_item']),
                        minimalPrice = product['discount']['minimal_price'];
                    if (promoDiscount === "" || promoDiscount === "100%" || promoDiscount === "null") {
                        discount = itemPrice;
                    } else if (promoDiscount.indexOf("%") !== -1) {
                        discount = this.getPercentDiscount(itemPrice, promoDiscount);
                    } else if (promoDiscount.indexOf("-") !== -1) {
                        discount = this.getFixedDiscount(itemPrice, promoDiscount);
                    } else {
                        discount = this.getFixedPrice(itemPrice, promoDiscount);
                    }
                    discount = this.getDiscountAfterMinimalPrice(minimalPrice, itemPrice, discount);
                    $(item).parent().find('span[data-price-type="newPrice"]').find('span[class="price"]')[0].innerHTML = priceUtils.formatPrice(itemPrice - discount, this.options.priceFormat);
                }
            }
        },
        getPercentDiscount: function(itemPrice, promoDiscount) {
            var percent = parseFloat(promoDiscount.replace("%", "", promoDiscount));
            return itemPrice * percent / 100;
        },
        getFixedDiscount: function(itemPrice, promoDiscount) {
            var discount = Math.abs(promoDiscount);
            if (discount > itemPrice) {
                discount = itemPrice;
            }
            return discount;
        },
        getFixedPrice: function(itemPrice, promoDiscount) {
            var discount = itemPrice - parseFloat(promoDiscount);
            if (discount < 0) {
                discount = 0;
            }
            return discount;
        },
        getDiscountAfterMinimalPrice: function(minimalPrice, itemPrice, discount) {
            itemPrice = Number(itemPrice);
            minimalPrice = Number(minimalPrice);
            if (itemPrice > minimalPrice && itemPrice - discount < minimalPrice) {
                discount = itemPrice - minimalPrice;
            }
            return discount;
        },
        _create: function() {
            $(this.quickViewItem).on('click', this.showQuickView);
            $(this.promoItem).on('click', this._selected);
            $(this.attribute).on('change', this.updateAttribute);
            $(this.addToCartBtn).on('click', this.addToCart);
            $(".ampromo-items-form").find('select').on('click', this.onChange)
        },
        showQuickView: function(e) {
            e.preventDefault();
            let productId = $(this).data('id');
            $.magnificPopup.open({
                items: {
                    src: urlBuilder.build('mgs_quickview/catalog_product/view/id/' + productId)
                },
                type: 'iframe',
                closeOnBgClick: false,
                scrolling: false,
                preloader: true,
                tLoading: '',
                callbacks: {
                    beforeOpen: function() {
                        $('body').trigger('processStart');
                    },
                    open: function() {
                        $(".mfp-iframe").css('opacity', 1).scrollTop(0);
                        $('.mfp-preloader').css('display', 'block');
                        $("iframe.mfp-iframe").addClass("show-iframe");
                        $('.mfp-wrap').css({
                            'top': 0
                        });
                        $('body').trigger('processStop');
                    },
                    close: function() {
                        $('.mfp-preloader').css('display', 'none');
                        $("html").removeClass('show-preview');
                    }
                }
            });
        },
        _selected: function() {
            $('.selected-promo-item').prop('checked', false);
            $('.selected-promo-item').removeClass('checked');
            $(this).prop('checked', true);
            $(this).addClass('checked');
            var sku = $(this).val();
            var color = $('.promo-super_attribute-color-' + sku).val();
            var size = $('.promo-super_attribute-size-' + sku).val();
            $('input[name="promo-item"]').val(sku);
            $('#product_addtocart_form input[name="promo-color"]').val(color);
            $('#product_addtocart_form input[name="promo-size"]').val(size);
        },
        updateAttribute: function() {
            var sku = $(this).attr('data-promo-sku');
            var isChecked = $('.selected-promo-item-' + sku).hasClass('checked');
            if (isChecked) {
                var attributeCode = $(this).attr('data-attribute-code');
                var value = $(this).val();
                if (attributeCode == 'color') {
                    $('#product_addtocart_form input[name="promo-color"]').val(value);
                }
                if (attributeCode == 'size') {
                    $('#product_addtocart_form input[name="promo-size"]').val(value);
                }
            }
        },
        addToCart: function() {
            var sku = $('#product_addtocart_form input[name="promo-item"]').val();
            var color = $('#product_addtocart_form input[name="promo-color"]').val();
            var size = $('#product_addtocart_form input[name="promo-size"]').val();
            if (sku && (!color || !size)) {
                $('#product_addtocart_form').validation('isValid');
                if (!$('.ampromo-items-form-' + sku).validation('isValid')) {
                    return false;
                }
            }
        },
        onChange: function() {
            var formId = $('#' + this.form.id),
                mageError = formId.find('.mage-error').length;
            if (mageError >= 1) {
                $(formId).valid();
            }
        }
    });
    return $.magenest.quickview;
});
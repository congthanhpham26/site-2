define(['jquery', 'Magento_Ui/js/modal/modal', 'mage/url', 'mage/translate'], function($, modal, url) {
    $.widget('magenest.review', {
        showPopupButton: '#open_module',
        popupForm: '#review-form',
        submitReviewButton: '.action.submit.primary',
        radioCheckbox: '#checkedRadio',
        radioErrorMessage: '#validate-review-radio',
        loadMoreButton: '#load_more',
        reviewList: '#customer-reviews',
        rateSort: '#rating-sort',
        dateSort: '#date-sort',
        reviewListItems: '.items.review-items',
        toolbar: '.items.review-items .toolbar.review-toolbar',
        swatchesOption: '#product_addtocart_form .swatch-attribute .swatch-option',
        reviewColor: '#review-color',
        reviewSize: '#review-size',
        sortBlock: '.block.review-list .block-content',
        options: {
            product_id: null,
        },
        _create: function() {
            $(this.showPopupButton).on('click', this.showPopup.bind(this));
            $(this.reviewList).on('click', this.loadMoreButton, this.loadMore.bind(this));
            $(this.dateSort).on('change', this._sort.bind(this));
            $(this.rateSort).on('change', this._sort.bind(this));
            $('body').on('click', this.swatchesOption, this.insertAttribute);
        },
        showPopup: function() {
            var options = {
                type: 'popup',
                responsive: false,
                innerScroll: false,
                title: '',
                buttons: [],
                modalClass: 'modal-review'
            };
            modal(options, $(this.popupForm));
            $(this.popupForm).modal("openModal");
        },
        validateForm: function() {
            var isChecked = $(this.radioCheckbox).is(':checked');
            if (isChecked === false) {
                $(this.radioErrorMessage).html($.mage.__('This is a required field.'));
                if ($(this.popupForm).valid()) {
                    return false;
                }
            } else {
                $(this.radioErrorMessage).html('');
            }
        },
        loadMore: function() {
            var self = this,
                totalPage = $(this.loadMoreButton).attr('data-total'),
                currentPage = $(this.loadMoreButton).attr('data-current'),
                rateSort = $(this.rateSort).val(),
                dateSort = $(this.dateSort).val();
            currentPage++;
            $(this.loadMoreButton).attr('data-current', currentPage);
            $.ajax({
                url: url.build("rating_comment/reviews/loadreviews"),
                method: "POST",
                data: {
                    productId: this.options.product_id,
                    p: currentPage,
                    rateSort: rateSort,
                    dateSort: dateSort
                },
                dataType: "json",
                beforeSend: function() {
                    $("body").trigger('processStart');
                },
                success: function(data) {
                    $(self.reviewListItems).append(data);
                    if (currentPage >= totalPage) {
                        $(self.loadMoreButton).css('display', 'none');
                    }
                },
                complete: function() {
                    $("body").trigger('processStop')
                }
            });
        },
        _sort: function() {
            var self = this,
                currentPage = Number(1),
                rateSort = $(this.rateSort).val(),
                dateSort = $(this.dateSort).val();
            $(this.loadMoreButton).attr('data-current', currentPage);
            $.ajax({
                url: url.build("rating_comment/reviews/loadreviews"),
                method: "POST",
                data: {
                    productId: this.options.product_id,
                    p: currentPage,
                    rateSort: rateSort,
                    dateSort: dateSort,
                    isViewMore: 1
                },
                dataType: "json",
                beforeSend: function() {
                    $("body").trigger('processStart');
                },
                success: function(data) {
                    $(self.sortBlock).html(data);
                },
                complete: function() {
                    $("body").trigger('processStop');
                }
            });
        },
        insertAttribute: function() {
            var attribute = $(this).parents('.swatch-attribute').attr('data-attribute-code'),
                attributeValue = $(this).parents('.swatch-attribute').find('.super-attribute-select').val();
            if (attribute == 'color') {
                if (attributeValue) {
                    attributeValue = $('#option-label-color-93-item-' + attributeValue).attr('data-option-label');
                }
                $('#review-color').val(attributeValue);
            } else if (attribute == 'size') {
                if (attributeValue) {
                    attributeValue = $('#option-label-size-192-item-' + attributeValue).attr('data-option-label');
                }
                $('#review-size').val(attributeValue);
            }
        }
    });
    return $.magenest.review;
});
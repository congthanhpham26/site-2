define(['jquery', 'jquery-ui-modules/widget'], function($) {
    'use strict';

    function parseHref(href) {
        var a = document.createElement('a');
        a.href = href;
        return a;
    }

    function parseURL(href, forceVideo) {
        var id, type, ampersandPosition, vimeoRegex, useYoutubeNocookie = false;

        function _getYoutubeId(srcid) {
            if (srcid) {
                ampersandPosition = srcid.indexOf('&');
                if (ampersandPosition === -1) {
                    return srcid;
                }
                srcid = srcid.substring(0, ampersandPosition);
            }
            return srcid;
        }
        if (typeof href !== 'string') {
            return href;
        }
        href = parseHref(href);
        if (href.host.match(/youtube\.com/) && href.search) {
            id = href.search.split('v=')[1];
            if (id) {
                id = _getYoutubeId(id);
                type = 'youtube';
            }
        } else if (href.host.match(/youtube\.com|youtu\.be|youtube-nocookie.com/)) {
            id = href.pathname.replace(/^\/(embed\/|v\/)?/, '').replace(/\/.*/, '');
            type = 'youtube';
            if (href.host.match(/youtube-nocookie.com/)) {
                useYoutubeNocookie = true;
            }
        } else if (href.host.match(/vimeo\.com/)) {
            type = 'vimeo';
            vimeoRegex = new RegExp(['https?:\\/\\/(?:www\\.|player\\.)?vimeo.com\\/(?:channels\\/(?:\\w+\\/)', '?|groups\\/([^\\/]*)\\/videos\\/|album\\/(\\d+)\\/video\\/|video\\/|)(\\d+)(?:$|\\/|\\?)'].join(''));
            id = href.href.match(vimeoRegex)[3];
        }
        if ((!id || !type) && forceVideo) {
            id = href.href;
            type = 'custom';
        }
        return id ? {
            id: id,
            type: type,
            s: href.search.replace(/^\?/, ''),
            useYoutubeNocookie: useYoutubeNocookie
        } : false;
    }
    return function() {
        $.widget('mage.AddFotoramaVideoEvents', $.mage.AddFotoramaVideoEvents, {
            _createVideoData: function(inputData, isJSON) {
                var videoData = [],
                    dataUrl, tmpVideoData, tmpInputData, i;
                if (isJSON) {
                    inputData = $.parseJSON(inputData);
                }
                for (i = 0; i < inputData.length; i++) {
                    tmpInputData = inputData[i];
                    dataUrl = '';
                    tmpVideoData = {
                        mediaType: '',
                        isBase: '',
                        id: '',
                        provider: ''
                    };
                    if (tmpInputData.mediaType === 'local-video') {
                        tmpVideoData.provider = 'video';
                        tmpVideoData.videoUrl = tmpInputData.videoUrl;
                    }
                    tmpVideoData.mediaType = this.VID;
                    if (tmpInputData.mediaType !== 'external-video') {
                        tmpVideoData.mediaType = tmpInputData.mediaType;
                    }
                    tmpVideoData.isBase = tmpInputData.isBase;
                    if (tmpInputData.videoUrl && tmpInputData.videoUrl !== null && tmpInputData.mediaType !== 'local-video') {
                        dataUrl = tmpInputData.videoUrl;
                        dataUrl = parseURL(dataUrl);
                        tmpVideoData.id = dataUrl.id;
                        tmpVideoData.provider = dataUrl.type;
                        tmpVideoData.videoUrl = tmpInputData.videoUrl;
                        tmpVideoData.useYoutubeNocookie = dataUrl.useYoutubeNocookie;
                    }
                    videoData.push(tmpVideoData);
                }
                return videoData;
            },
            _checkForVideo: function(e, fotorama, number) {
                var videoData = this.options.videoData[number - 1],
                    $image = fotorama.data[number - 1];
                if ($image) {
                    !$image.type && this._setItemType($image, number - 1);
                    if ($image.type === 'image') {
                        $image.$navThumbFrame && $image.$navThumbFrame.removeClass(this.TI);
                        this._hideCloseVideo();
                        return;
                    } else if ($image.$navThumbFrame && $image.type === 'video') {
                        !$image.$navThumbFrame.hasClass(this.TI) && $image.$navThumbFrame.addClass(this.TI);
                    }
                    $image = $image.$stageFrame;
                }
                if (($image && videoData) && (videoData.mediaType === this.VID || videoData.mediaType === 'local-video')) {
                    $(fotorama.activeFrame.$stageFrame).removeAttr('href');
                    this._prepareForVideoContainer($image, videoData, fotorama, number);
                }
                if (this.isFullscreen && this.fotoramaItem.data('fotorama').activeFrame.i === number) {
                    this.fotoramaItem.data('fotorama').activeFrame.$stageFrame[0].click();
                }
            },
            _handleBaseVideo: function(fotorama, srcNumber) {
                var waitForFroogaloop, videoData = this.options.videoData,
                    activeIndex = fotorama.activeIndex,
                    number = parseInt(srcNumber, 10),
                    activeIndexIsBase = videoData[activeIndex];
                if (activeIndexIsBase.isBase && activeIndexIsBase.mediaType === 'local-video') {
                    setTimeout($.proxy(function() {
                        this._autoplayVideo('', fotorama, srcNumber);
                    }, this), 50);
                    return;
                }
                if (!this.Base) {
                    return;
                }
                if (activeIndexIsBase && number === 1 && $(window).width() > this.MobileMaxWidth) {
                    if (this.options.videoData[fotorama.activeIndex].provider === this.VI) {
                        waitForFroogaloop = setInterval($.proxy(function() {
                            if (window.Froogaloop) {
                                clearInterval(waitForFroogaloop);
                                fotorama.requestFullScreen();
                                this.fotoramaItem.data('fotorama').activeFrame.$stageFrame[0].click();
                                this.Base = false;
                            }
                        }, this), 50);
                    } else {
                        setTimeout($.proxy(function() {
                            fotorama.requestFullScreen();
                            this.fotoramaItem.data('fotorama').activeFrame.$stageFrame[0].click();
                            this.Base = false;
                        }, this), 50);
                    }
                }
            },
            _prepareForVideoContainer: function($image, videoData, fotorama, number) {
                if (videoData.mediaType === 'local-video') {
                    $image.addClass('local-video');
                }
                $image.addClass('fotorama-video-container').addClass(this.VU);
                this._createVideoContainer(videoData, $image);
                this._setVideoEvent($image, this.PV, fotorama, number);
            },
            _startPrepareForPlayer: function(e, fotorama) {
                this._unloadVideoPlayer(fotorama.activeFrame.$stageFrame.parent(), fotorama, false);
                this._checkForVideo(e, fotorama, fotorama.activeFrame.i);
                this._checkForVideo(e, fotorama, fotorama.activeFrame.i - 1);
                this._checkForVideo(e, fotorama, fotorama.activeFrame.i + 1);
                this._autoplayVideo(e, fotorama, fotorama.activeFrame.i);
            },
            _autoplayVideo: function(e, fotorama, number) {
                var videoData = this.options.videoData[number - 1],
                    $image = fotorama.data[number - 1],
                    imageType = $image.type;
                if ($image) {
                    $image = $image.$stageFrame;
                }
                if (imageType === 'video' && ($image && videoData) && (videoData.mediaType === this.VID || videoData.mediaType === 'local-video')) {
                    $(fotorama.activeFrame.$stageFrame).removeAttr('href');
                    $image.click();
                    this._showCloseVideo();
                }
            },
            _checkForVideoExist: function() {
                var key, result, checker, videoSettings;
                if (!this.options.videoData) {
                    return false;
                }
                if (!this.options.videoSettings) {
                    return false;
                }
                result = this._createVideoData(this.options.videoData, false);
                checker = false;
                videoSettings = this.options.videoSettings[0];
                videoSettings.playIfBase = parseInt(videoSettings.playIfBase, 10);
                videoSettings.showRelated = parseInt(videoSettings.showRelated, 10);
                videoSettings.videoAutoRestart = parseInt(videoSettings.videoAutoRestart, 10);
                for (key in result) {
                    if (result[key].mediaType === this.VID || result[key].mediaType === 'local-video') {
                        checker = true;
                    }
                }
                if (checker) {
                    this.options.videoData = result;
                }
                return checker;
            },
            _closeVideoSetEvents: function($closeVideo, fotorama) {
                $closeVideo.on('click', $.proxy(function() {
                    this._unloadVideoPlayer(fotorama.activeFrame.$stageFrame.parent(), fotorama, true);
                    this._removeVideoPlayer(fotorama.activeFrame.$stageFrame.parent(), fotorama, true);
                    this._hideCloseVideo();
                }, this));
            },
            _removeVideoPlayer: function($wrapper, current, close) {
                var self = this;
                $wrapper.find('.' + this.PV).each(function() {
                    var $item = $(this).parent(),
                        cloneVideoDiv, iframeElement = $(this).find('video'),
                        currentIndex, itemIndex;
                    if (iframeElement.length === 0) {
                        return;
                    }
                    currentIndex = current.activeFrame.$stageFrame.index();
                    itemIndex = $item.index();
                    if (currentIndex === itemIndex && !close) {
                        return;
                    }
                    if (currentIndex !== itemIndex && close) {
                        return;
                    }
                    iframeElement.remove();
                    cloneVideoDiv = $(this).clone();
                    $(this).remove();
                    $item.append(cloneVideoDiv);
                    $item.addClass(self.VU);
                    self._hideCloseVideo();
                    self._hideVideoArrows();
                    if (self.isFullscreen && !self.fotoramaItem.data('fotorama').options.fullscreen.arrows) {
                        if ($('.' + self.FTAR + '--prev').is(':focus') || $('.' + self.FTAR + '--next').is(':focus')) {
                            $(self.FTCF).focus();
                        }
                    }
                });
            },
            _createVideoContainer: function(videoData, $image) {
                var videoSettings;
                videoSettings = this.options.videoSettings[0];
                $image.find('.' + this.PV).remove();
                $image.append('<div class="' +
                    this.PV + '" data-related="' +
                    videoSettings.showRelated + '" data-loop="' +
                    videoSettings.videoAutoRestart + '" data-type="' +
                    videoData.provider + '" data-code="' +
                    videoData.id + '" data-videoUrl="' +
                    videoData.videoUrl + '"  data-youtubenocookie="' +
                    videoData.useYoutubeNocookie + '" data-width="100%" data-height="100%"></div>');
            },
        });
        return $.mage.AddFotoramaVideoEvents;
    };
});